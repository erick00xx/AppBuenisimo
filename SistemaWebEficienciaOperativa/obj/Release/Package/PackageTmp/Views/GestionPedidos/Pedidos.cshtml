@* En Views/GestionPedidos/Pedidos.cshtml *@
@model SistemaWebEficienciaOperativa.Models.tbDetallePedido 

@{
    ViewBag.Title = "Crear Pedido para Mesa " + ViewBag.IdMesa; // Mostrar el número de mesa si lo pasas
}

<h2>Crear Pedido para Mesa @ViewBag.IdMesa</h2>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}

<!-- Buscador -->
<input type="text" id="search" placeholder="Buscar producto..." class="form-control mb-3" />

<!-- Lista de productos encontrados -->
<ul id="productos-list" class="list-group mt-3 mb-3">
    <!-- Los productos serán añadidos dinámicamente aquí -->
</ul>

<h3>Productos seleccionados</h3>

<!-- Lista de productos seleccionados -->
<ul id="productos-seleccionados" class="list-group mt-3 mb-3">
    <!-- Los productos seleccionados se mostrarán aquí -->
    @*  *@
</ul>

<form id="pedido-form" action="@Url.Action("GuardarPedido", "GestionPedidos")" method="post">
    @Html.AntiForgeryToken() <!-- Buena práctica para seguridad contra CSRF -->
    <input type="hidden" id="detalle-pedido" name="detallePedido" />
    <input type="hidden" name="idMesa" value="@ViewBag.IdMesa" /> @* ¡IMPORTANTE! Pasar el idMesa *@
    <button type="submit" class="btn btn-success mt-3">Guardar Pedido</button>
    @Html.ActionLink("Cancelar", "Index", "GestionPedidos", null, new { @class = "btn btn-secondary mt-3 ml-2" })
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Al escribir en el buscador
        $("#search").on("input", function () {
            var searchTerm = $(this).val();
            if (searchTerm.length >= 2) {  // Puedes ajustar a 2 o 3 caracteres
                $.ajax({
                    url: '@Url.Action("BuscarProductos", "GestionPedidos")',
                    data: { term: searchTerm },
                    dataType: 'json',
                    success: function (data) {
                        $("#productos-list").empty();
                        if (data.length > 0) {
                            data.forEach(function (producto) {
                                $("#productos-list").append(
                                    `<li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${producto.Producto}</strong> (${producto.TipoMedida} - ${producto.Medida})<br/>
                                            <small>${producto.Categoria} (${producto.TipoProducto})</small><br/>
                                            S/.${parseFloat(producto.Precio).toFixed(2)}
                                        </div>
                                        <button class="btn btn-primary btn-sm add-producto" data-id="${producto.Id}" data-nombre="${producto.Producto}" data-precio="${producto.Precio}">Añadir</button>
                                    </li>`
                                );
                            });
                        } else {
                            $("#productos-list").append("<li class='list-group-item'>No se encontraron productos.</li>");
                        }
                    },
                    error: function() {
                        $("#productos-list").empty().append("<li class='list-group-item text-danger'>Error al buscar productos.</li>");
                    }
                });
            } else {
                $("#productos-list").empty();
            }
        });

        // Añadir el producto a la lista de productos seleccionados
        $(document).on("click", ".add-producto", function () {
            var productoId = $(this).data("id");
            var productoNombre = $(this).data("nombre");
            var productoPrecio = parseFloat($(this).data("precio")).toFixed(2);

            // Verificar si el producto ya está en la lista de seleccionados
            if ($(`#productos-seleccionados li[data-id="${productoId}"]`).length > 0) {
                alert("Este producto ya ha sido añadido. Puede modificar su cantidad.");
                return;
            }

            $("#productos-seleccionados").append(
                `<li class="list-group-item d-flex justify-content-between align-items-center" data-id="${productoId}" data-precio="${productoPrecio}">
                    <div>
                        ${productoNombre} - S/.${productoPrecio}
                    </div>
                    <div>
                        <input type="number" class="form-control cantidad d-inline-block" value="1" min="1" style="width: 70px;" />
                        <button class="btn btn-danger btn-sm remove-producto ml-2">Eliminar</button>
                    </div>
                </li>`
            );
            $("#productos-list").empty(); // Limpiar resultados de búsqueda
            $("#search").val(''); // Limpiar campo de búsqueda
        });

        // Eliminar producto de la lista seleccionada
        $(document).on("click", ".remove-producto", function () {
            $(this).closest("li").remove();
        });

        // Enviar el formulario con los productos seleccionados y sus cantidades
        $("#pedido-form").submit(function (e) {
            var detallePedido = [];

            $("#productos-seleccionados li").each(function () {
                var productoId = $(this).data("id");
                var cantidad = parseInt($(this).find(".cantidad").val()); // Asegurarse que es un número

                if (cantidad > 0) {
                    detallePedido.push({
                        idPrecio: productoId, // Esto es en realidad idPrecio
                        cantidad: cantidad
                    });
                }
            });

            if (detallePedido.length === 0) {
                e.preventDefault(); // Detener el envío del formulario
                alert("Debe seleccionar al menos un producto y especificar una cantidad válida.");
                return;
            }

            // Convertir el array a JSON y colocarlo en el campo hidden
            $("#detalle-pedido").val(JSON.stringify(detallePedido));

            // El formulario se enviará normalmente si no se previene
        });
    });
</script>
<style>
    /* Estilos básicos para mejorar la apariencia si no usas Bootstrap completo */
    .d-flex {
        display: flex !important;
    }

    .justify-content-between {
        justify-content: space-between !important;
    }

    .align-items-center {
        align-items: center !important;
    }

    .mb-3 {
        margin-bottom: 1rem !important;
    }

    .mt-3 {
        margin-top: 1rem !important;
    }

    .ml-2 {
        margin-left: .5rem !important;
    }

    .d-inline-block {
        display: inline-block !important;
    }
</style>